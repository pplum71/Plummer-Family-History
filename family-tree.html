<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree · Plummer Family History</title>
  <meta name="description" content="A multipage family history site for preserving stories, photos, and the family tree." />
  <link rel="stylesheet" href="./assets/style.css" />
</head>
<body>
  
    <nav class="nav">
      <div class="nav-inner nav">
        <div class="brand">
          <img src="./assets/logo.png" alt="Plummer Crest" style="height:28px;width:auto" />
          <span>Plummer Family History</span>
        </div>
        <ul class="nav">
          <li><a href="index.html" >Home</a></li>
          <li><a href="family-tree.html" aria-current="page">Family Tree</a></li>
          <li><a href="stories.html" >Stories</a></li>
          <li><a href="photos.html" >Photos</a></li>
          <li><a href="contact.html" >Contact</a></li>
          </ul>
      </div>
    </nav>
    
  

<main class="container">
  <h1>Family Tree</h1>
  <p class="small" id="data-status">Initializing Firebase. Tree loading in real-time...</p>

  <section style="margin-top:24px">
    <h2>Interactive Tree (D3 SVG)</h2>
    <p class="small">This tree is generated from **Firestore** using the <code>parents</code> links. Click nodes to expand/collapse. Years reflect full lifespan.</p>
    <div id="d3-tree-root" class="figure"></div>
  </section>

  <section style="margin-top:24px">
    <h2>Simple Collapsible List</h2>
    <div id="tree"></div>
  </section>
  
  <div id="tree-embed-wrap" class="figure" style="margin-top:24px">
    <h2>Tree Embed Placeholder</h2>
    <p class="small">If you are using an external tree viewer, it would load here from <code>data/tree-embed.html</code>.</p>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  
  // setLogLevel('debug'); // Uncomment for debugging
  
  // --- Initialization and Global Setup ---
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  let userId = null;
  
  const statusEl = document.getElementById('data-status');
  
  // --- Core Tree Utility Functions ---
  
  // Helper to construct the node label (e.g., John Smith (1900 - 1980))
  function label(pData){
    const birthYear = pData.birth?.date?.slice(-4) || pData.birthYear || '';
    const deathYear = pData.death?.date?.slice(-4) || '';

    const lifeYears = [birthYear, deathYear].filter(Boolean).join(' - ');
    const dates = lifeYears ? ` (${lifeYears})` : '';
    
    return `${pData.name||pData.id}${dates}`;
  }

  // Helper function to build the hierarchical data structure for D3/List
  function buildTree(id, byId, childrenMap, visited=new Set()){
    if(visited.has(id)) return null; 
    visited.add(id);
    const p = byId.get(id) || {id, name:id};
    const kids = (childrenMap[id]||[])
      .map(k => buildTree(k, byId, childrenMap, new Set(visited)))
      .filter(Boolean);
    
    // Pass the raw data object 'p' as 'data' for the D3 rendering functions
    return { id, name: p.name||id, data:p, children:kids };
  }

  // --- 1. List-Based Tree Renderer ---

  function nodeHTML(id, byId, childrenMap){
    const p = byId.get(id) || {id};
    const kids = (childrenMap[id]||[]).sort((a,b)=> (byId.get(a)?.birth?.date||'').localeCompare(byId.get(b)?.birth?.date||''));
    const hasKids = kids.length>0;
    
    const nodeLabel = label(p);
    
    return `<li>
      <span class="tree-node" data-id="${id}" ${hasKids?'':'data-leaf="1"'}>${nodeLabel}</span>
      ${hasKids? `<ul class="collapsed">${kids.map(k => nodeHTML(k, byId, childrenMap)).join('')}</ul>` : ''}
    </li>`;
  }
  
  function renderListTree(people) {
    const byId = new Map(people.filter(p=>p.id).map(p=>[p.id, p]));
    const childrenMap = {};
    people.forEach(p => (p.parents||[]).forEach(parentId => {
      (childrenMap[parentId] ||= []).push(p.id);
    }));

    const allIds = new Set(people.filter(p=>p.id).map(p=>p.id));
    const referencedAsChild = new Set(people.flatMap(p => (p.parents||[])));
    const roots = [...allIds].filter(id => !referencedAsChild.has(id));

    const html = `<ul class="tree-root">${roots.map(r => nodeHTML(r, byId, childrenMap)).join('')}</ul>`;
    const el = document.getElementById('tree');
    el.innerHTML = html;
    
    // Add toggle functionality (Styles for this are in the first script block)
    el.addEventListener('click', (e)=>{
        const node = e.target.closest('.tree-node'); if(!node || node.dataset.leaf) return;
        const nextUl = node.nextElementSibling; if(!nextUl) return;
        nextUl.classList.toggle('collapsed');
    });
  }


  // --- 2. D3 Tree (SVG) Renderer ---
  
  function renderD3Tree(people){
    const byId = new Map(people.filter(p=>p.id).map(p=>[p.id,p]));
    const childrenMap = {};
    people.forEach(p => (p.parents||[]).forEach(pid => {
      (childrenMap[pid] ||= []).push(p.id);
    }));
    const allIds = new Set(people.filter(p=>p.id).map(p=>p.id));
    const referencedAsChild = new Set(people.flatMap(p => (p.parents||[])));
    const roots = [...allIds].filter(id => !referencedAsChild.has(id));
    
    const forests = roots.map(r => buildTree(r, byId, childrenMap)).filter(Boolean);

    const container = d3.select('#d3-tree-root').html(''); 
    const width = Math.min(1000, document.body.clientWidth - 40);
    const nodeRadius = 6;

    forests.forEach((rootData) => {
      const root = d3.hierarchy(rootData, d => d.children);
      root.descendants().forEach(d => { if(d.depth > 1) d._children = d.children, d.children = null; });

      const dx = 22; 
      const dy = 140; 
      const tree = d3.tree().nodeSize([dx, dy]);
      const diagonal = d3.linkHorizontal().x(d => d.y).y(d => d.x);

      const svg = container.append('svg')
        .attr('width', width)
        .attr('viewBox', [ -20, -20, width, 200 ].join(' '))
        .style('display','block')
        .style('margin','12px 0')
        .style('background','none');

      const g = svg.append('g');

      function update(source){
        tree(root);
        let left = Infinity, right = -Infinity;
        root.each(d => { if(d.x < left) left = d.x; if(d.x > right) right = d.x; });
        const height = right - left + 40;
        svg.attr('viewBox', [ -20, left - 20, Math.max(width, root.height*dy + 120), height ].join(' '));

        const nodes = root.descendants();
        const links = root.links();

        // Links
        const link = g.selectAll('path.link')
          .data(links, d => d.target.data.id);

        link.enter().append('path')
          .attr('class','link')
          .attr('fill','none')
          .attr('stroke','rgba(255,255,255,0.25)')
          .attr('stroke-width',1.2)
          .attr('d', d => diagonal({ source: {x: source.x0 || 0, y: source.y0 || 0}, target: {x: source.x0 || 0, y: source.y0 || 0} }))
          .merge(link)
          .transition().duration(350)
          .attr('d', diagonal);

        link.exit().transition().duration(200).attr('opacity',0).remove();

        // Nodes
        const node = g.selectAll('g.node')
          .data(nodes, d => d.data.id);

        const nodeEnter = node.enter().append('g')
          .attr('class','node')
          .attr('transform', d => `translate(${source.y0||0},${source.x0||0})`)
          .attr('cursor', d => (d.children || d._children) ? 'pointer' : 'default')
          .on('click', (event,d)=>{
            if(d.children){ d._children = d.children; d.children = null; }
            else if(d._children){ d.children = d._children; d._children = null; }
            update(d);
          });

        nodeEnter.append('circle')
          .attr('r', 0)
          .attr('fill', d => d._children ? 'rgba(139,211,255,0.8)' : 'rgba(255,255,255,0.5)')
          .attr('stroke', 'rgba(255,255,255,0.6)')
          .attr('stroke-width', 1.2)
          .transition().duration(350)
          .attr('r', nodeRadius);

        nodeEnter.append('text')
          .attr('dy', '0.32em')
          .attr('x', d => d._children ? -10 : 10)
          .attr('text-anchor', d => d._children ? 'end' : 'start')
          .attr('font-size', 12)
          .attr('fill', '#e6eef7')
          .text(d => label(d.data)) // Use the data object for labeling
          .clone(true).lower()
          .attr('stroke', 'rgba(11,15,20,0.85)')
          .attr('stroke-width', 4);

        const nodeUpdate = nodeEnter.merge(node);
        nodeUpdate.transition().duration(350)
          .attr('transform', d => `translate(${d.y},${d.x})`);

        const nodeExit = node.exit().transition().duration(200)
          .attr('transform', d => `translate(${source.y},${source.x})`)
          .attr('opacity', 0)
          .remove();

        root.each(d => { d.x0 = d.x; d.y0 = d.y; });
      }

      root.x0 = 0; root.y0 = 0;
      update(root);
    });
  }
  
  // --- Firebase Loading and Authentication ---
  
  function getPeopleCollectionRef(currentUserId) {
    if (!currentUserId) throw new Error("User ID is required for path.");
    const path = `/artifacts/${appId}/users/${currentUserId}/people`;
    return collection(db, path);
  }

  function subscribeToPeople(currentUserId) {
    const peopleCollectionRef = getPeopleCollectionRef(currentUserId);
    
    onSnapshot(peopleCollectionRef, (snapshot) => {
        const people = snapshot.docs.map(doc => doc.data());
        
        renderListTree(people);
        renderD3Tree(people);

        statusEl.textContent = `Tree data loaded for ${people.length} people from Firestore.`;

    }, (error) => {
        console.error("Error fetching people data:", error);
        statusEl.textContent = `Error loading data: ${error.message}`;
    });
  }

  onAuthStateChanged(auth, async (user) => {
      if (user) {
          userId = user.uid;
          subscribeToPeople(userId);
      } else {
          // Attempt to sign in anonymously to get a user ID to read the associated data
          if (initialAuthToken) {
              await signInWithCustomToken(auth, initialAuthToken);
          } else {
              await signInAnonymously(auth);
          }
      }
  });

</script>

  <footer>
    © <span id="y"></span> Plummer Family — Built with care. | <span class="small">Admin: open <code>/admin.html?key=YOURSECRET</code></span>
  </footer>
  <script src="./assets/script.js"></script>
  <script>document.getElementById('y').textContent=new Date().getFullYear()</script>
</body>
</html>

