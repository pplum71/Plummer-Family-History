<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>People · Plummer Family History</title>
  <meta name="description" content="A multipage family history site for preserving stories, photos, and the family tree." />
  <link rel="stylesheet" href="./assets/style.css" />
</head>
<body>
  
    <nav class="nav">
      <div class="nav-inner nav">
        <div class="brand">
          <img src="./assets/logo.png" alt="Plummer Crest" style="height:28px;width:auto" />
          <span>Plummer Family History</span>
        </div>
        <ul class="nav">
          <li><a href="index.html" >Home</a></li>
          <li><a href="family-tree.html" >Family Tree</a></li>
          <li><a href="stories.html" >Stories</a></li>
          <li><a href="photos.html" >Photos</a></li>
          <li><a href="contact.html" >Contact</a></li>
          <!-- Admin is intentionally not linked in nav -->
        </ul>
      </div>
    </nav>
    
  
<main class="container">
  <h1>People</h1>
  <div class="searchbar">
    <input id="q" class="input" placeholder="Search by name, place, or note…" />
    <span class="small" id="data-status">Data: Initializing Firebase...</span>
  </div>
  <section id="people" class="grid"></section>
</main>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  
  // --- UTILITY FUNCTIONS (Integrated to fix module errors) ---
  
  /**
   * Creates the HTML card structure for a single person object.
   * @param {Object} p - The person object from people.json (or Firestore).
   * @returns {string} - The HTML string for the person card.
   */
  function cardPerson(p) {
    // 1. Calculate the life years (e.g., "1900 - 1980")
    const birthYear = p.birth?.date?.slice(-4) || p.birthYear || '';
    const deathYear = p.death?.date?.slice(-4) || '';
    
    const lifeYears = [birthYear, deathYear].filter(Boolean).join(' - ');
    const dates = lifeYears ? ` (${lifeYears})` : '';

    // 2. Format detailed birth/death info for the card body
    const formatEvent = (event, label) => {
        if (!event || (!event.place && !event.date)) return '';
        const place = event.place ? event.place : '';
        const date = event.date ? `(${event.date})` : '';
        return `<strong>${label}:</strong> ${place} ${date}<br>`;
    };
    
    const birthInfo = formatEvent(p.birth, 'Born');
    const deathInfo = formatEvent(p.death, 'Died');
    const marriageInfo = formatEvent(p.marriage, 'Married');
    
    const lifeEvents = birthInfo || deathInfo || marriageInfo ? 
      `<p class="small details-list">
        ${birthInfo}
        ${deathInfo}
        ${marriageInfo}
      </p>` 
      : '';

    // 3. Assemble the final card HTML
    return `<article class="card">
        <h3>${p.name || 'Unknown Person'}${dates}</h3>
        ${lifeEvents}
        <p>${p.summary || 'No summary available.'}</p>
        <p class="small id-tag">ID: ${p.id || 'N/A'}</p>
    </article>`;
  }

  /**
   * Filters the list of people based on a search query.
   * @param {Array<Object>} list - The full list of people.
   * @param {string} query - The search string from the input box.
   * @returns {Array<Object>} - The filtered list of people.
   */
  function filterPeople(list, query) {
    const q = query.toLowerCase().trim();
    if (!q) {
        return list; // Return all if query is empty
    }

    return list.filter(p => {
        // Concatenate all searchable fields into one large string
        const searchableText = [
            p.name,
            p.summary,
            p.location,
            p.birth?.date,
            p.birth?.place,
            p.death?.date,
            p.death?.place,
            p.marriage?.date,
            p.marriage?.place,
            p.id,
        ].filter(s => s).join(' ').toLowerCase(); 

        return searchableText.includes(q);
    });
  }

  // --- FIREBASE AND INITIALIZATION ---
  
  // setLogLevel('debug'); // Uncomment for debugging
  
  // Global variables provided by the environment
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  let userId = null;
  
  const container = document.getElementById('people');
  const statusEl = document.getElementById('data-status');
  const searchInput = document.getElementById('q');
  
  let peopleList = [];

  // Define the path to the user's private collection
  function getPeopleCollectionRef(currentUserId) {
    if (!currentUserId) throw new Error("User ID is required for path.");
    const path = `/artifacts/${appId}/users/${currentUserId}/people`;
    return collection(db, path);
  }

  function subscribeToPeople(currentUserId) {
    const peopleCollectionRef = getPeopleCollectionRef(currentUserId);
    
    // onSnapshot provides real-time updates
    onSnapshot(peopleCollectionRef, (snapshot) => {
        peopleList = snapshot.docs.map(doc => doc.data());
        
        // Initial render and set up search
        render(peopleList);
        statusEl.textContent = `Data: Loaded ${peopleList.length} people from Firestore.`;
        searchInput.removeEventListener('input', handleSearch);
        searchInput.addEventListener('input', handleSearch);

    }, (error) => {
        console.error("Error fetching people data:", error);
        statusEl.textContent = `Error loading data: ${error.message}`;
        container.innerHTML = '<div class="alert">Could not load people data from Firestore.</div>';
    });
  }

  function handleSearch() {
    const filteredList = filterPeople(peopleList, searchInput.value);
    render(filteredList);
  }
  
  function render(items) {
    container.innerHTML = items.map(cardPerson).join('');
  }

  // --- AUTHENTICATION AND STARTUP ---
  onAuthStateChanged(auth, async (user) => {
      if (user) {
          userId = user.uid;
          subscribeToPeople(userId);
      } else {
          // Sign in anonymously to get a userId to read data from the system's default admin (or just to authenticate).
          if (initialAuthToken) {
              await signInWithCustomToken(auth, initialAuthToken);
          } else {
              await signInAnonymously(auth);
          }
      }
  });

</script>

  <footer>
    © <span id="y"></span> Plummer Family — Built with care. | <span class="small">Admin: open <code>/admin.html?key=YOURSECRET</code></span>
  </footer>
  <script>document.getElementById('y').textContent=new Date().getFullYear()</script>
</body>
</html>
