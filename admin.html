<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin · Plummer Family History</title>
  <meta name="description" content="A multipage family history site for preserving stories, photos, and the family tree." />
  <link rel="stylesheet" href="./assets/style.css" />
</head>
<body>
  
    <nav class="nav">
      <div class="nav-inner nav">
        <div class="brand">
          <img src="./assets/logo.png" alt="Plummer Crest" style="height:28px;width:auto" />
          <span>Plummer Family History</span>
        </div>
        <ul class="nav">
          <li><a href="index.html" >Home</a></li>
          <li><a href="family-tree.html" >Family Tree</a></li>
          <li><a href="stories.html" >Stories</a></li>
          <li><a href="photos.html" >Photos</a></li>
          <li><a href="contact.html" >Contact</a></li>
          <!-- Admin is intentionally not linked in nav -->
        </ul>
      </div>
    </nav>
    
  <!-- FIX: Define the adminGate function here so it's available when called at the end of the body -->
  <script>
    function adminGate(secretKey) {
        const query = new URLSearchParams(window.location.search);
        const key = query.get('key');
        const content = document.getElementById('admin-content');
        const locked = document.getElementById('admin-locked');
        
        if (!key || key !== secretKey) {
            if (content) content.style.display = 'none';
            if (locked) locked.classList.remove('hidden');
        } else {
            if (content) content.style.display = 'block';
            if (locked) locked.classList.add('hidden');
        }
    }
  </script>

<main class="container">
  <h1>Admin</h1>
  <div id="admin-locked" class="alert hidden">This page is locked. Append <code>?key=P@ttasPMJaca0292</code> to the URL (replace with your secret).</div>
  <div id="admin-content">
    
    <!-- NOTE: The People Manager now uses Firestore for persistent storage. -->
    <p class="alert-info alert" id="firebase-status">Initializing Firestore...</p>

    <hr/>
    <h3 id="tree-embed">Interactive Tree Embed</h3>
    <p class="small">Edit the HTML shown on the Family Tree page under “Interactive Tree (Embed)”. You can paste D3 scripts, an SVG, or an <code>&lt;iframe&gt;</code> to another viewer.</p>
    <textarea id="te_editor" class="input" rows="10" placeholder="Paste your embed HTML here"></textarea>
    <div class="cta">
      <button id="te_load" class="button">Load current embed</button>
      <button id="te_save_local" class="button">Save draft (local)</button>
      <button id="te_commit" class="button">Commit tree-embed.html to GitHub</button>
      <button id="te_reset" class="button">Reset to placeholder</button>
    </div>
    <script>
      const TE_KEY = 'treeEmbedDraft';
      function te_save(){ localStorage.setItem(TE_KEY, document.getElementById('te_editor').value); }
      function te_loadLocal(){ return localStorage.getItem(TE_KEY) || ''; }
      async function te_loadRemote(){
        const t = await fetch('./data/tree-embed.html', {cache:'no-store'}).then(r=> r.ok ? r.text() : '');
        document.getElementById('te_editor').value = t;
      }
      document.getElementById('te_load').addEventListener('click', te_loadRemote);
      document.getElementById('te_save_local').addEventListener('click', ()=>{ te_save(); alert('Draft saved in this browser.'); });
      document.getElementById('te_reset').addEventListener('click', ()=>{
        document.getElementById('te_editor').value = '<div class="figure">Add your interactive tree here (D3, SVG, or an embedded viewer).</div>';
      });
      // The old te_commit function using gh_commitFile is removed as we focus on Firestore now.
      document.getElementById('te_commit').addEventListener('click', ()=>{
          alert('Note: File commits (like tree-embed.html) still rely on GitHub settings. People Manager now uses Firestore.');
      });
      // Prefill with local draft or remote on first load
      window.addEventListener('DOMContentLoaded', async ()=>{
        const draft = te_loadLocal();
        if(draft){ document.getElementById('te_editor').value = draft; }
        else { try{ await te_loadRemote(); }catch(_){} }
      });
    </script>

    <hr/>
    <h3 id="people-manager">People Manager (Firestore Enabled)</h3>
    <p class="small">IDs must be unique (e.g., <code>john-gordon-plummer-1890</code>). Parents/Spouses: comma-separated IDs.</p><p class="small"><a class="button" href="./people.html" target="_blank" rel="noreferrer">Open public People page</a></p>
    <p class="small">**All changes are saved directly to Firestore** (in your private space) and reflected instantly on the public pages.</p>
    
    <!-- New Input Fields for detailed data -->
    <div class="row">
      <input id="pm_name" class="input" placeholder="Full name (required)"/>
      <input id="pm_summary" class="input" placeholder="One-line summary (e.g., 'Teacher, loved music')"/>
    </div>
    
    <div class="row">
      <input id="pm_id" class="input" placeholder="ID (auto from name if blank)"/>
      <input id="pm_parents" class="input" placeholder="Parents (IDs, comma-separated)"/>
      <input id="pm_spouses" class="input" placeholder="Spouses (IDs, comma-separated)"/>
    </div>
    
    <div class="row" style="margin-top:10px">
        <label style="width:100%;font-size:0.8em;opacity:0.8;margin-bottom: -10px;">Birth Details</label>
        <input id="pm_birth_date" class="input" placeholder="Birth Date (e.g., 1 Jan 1900)"/>
        <input id="pm_birth_place" class="input" placeholder="Birth Place / Location"/>
    </div>
    <div class="row" style="margin-top:10px">
        <label style="width:100%;font-size:0.8em;opacity:0.8;margin-bottom: -10px;">Death Details</label>
        <input id="pm_death_date" class="input" placeholder="Death Date (optional)"/>
        <input id="pm_death_place" class="input" placeholder="Death Place (optional)"/>
    </div>
    <div class="row" style="margin-top:10px">
        <label style="width:100%;font-size:0.8em;opacity:0.8;margin-bottom: -10px;">Marriage Details</label>
        <input id="pm_marriage_date" class="input" placeholder="Marriage Date (optional)"/>
        <input id="pm_marriage_place" class="input" placeholder="Marriage Place (optional)"/>
    </div>

    <div class="cta">
      <button id="pm_add" class="button">Add Person to Firestore</button>
      <label class="button" for="pm_import_file" style="cursor:pointer">Import People Data (JSON)</label>
      <input id="pm_import_file" type="file" accept=".json,application/json" style="display:none"/>
      <button id="pm_clear" class="button">Clear Local Fields</button>
    </div>
    <div class="small">Note: All live data management requires a custom component with Firebase. The previous import/export/commit features for people.json are no longer supported in this mode.</div>
    <div id="pm_table_wrap" class="container" style="padding:0">
      <!-- Updated Table Headers to reflect detailed fields -->
      <table id="pm_table" style="width:100%;border-collapse:collapse;margin-top:12px">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Name / ID</th>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Birth (Date/Place)</th>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Death (Date/Place)</th>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Relationships (P/S)</th>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Summary</th>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Actions</th>
          </tr>
        </thead>
        <tbody id="pm_body"></tbody>
      </table>
    </div>
    
    <!-- Firebase Imports and Admin-specific logic -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, setDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      
      setLogLevel('debug');
      
      // Mandatory Firebase Config and IDs
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
      
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      
      let userId = null;
      const pmState = { list: [] };

      // Helper function to create a new ID from name and birth date
      function slugify(text) {
          if (!text) return '';
          return text.toString().toLowerCase()
              .replace(/\s+/g, '-')
              .replace(/[^\w\-]+/g, '')
              .replace(/\-\-+/g, '-')
              .replace(/^-+/, '')
              .replace(/-+$/, '');
      }
      
      // --- FIRESTORE FUNCTIONS ---
      
      // Define the collection path (private data for admin management)
      function getPeopleCollectionRef() {
          if (!userId) throw new Error("User not authenticated.");
          const path = `/artifacts/${appId}/users/${userId}/people`;
          return collection(db, path);
      }
      
      // Function to add a new person or update an existing one
      async function addPersonToFirestore(person) {
          try {
              if (!userId) {
                  throw new Error("Cannot save: Authentication not complete.");
              }
              const personDocRef = doc(getPeopleCollectionRef(), person.id);
              // Use setDoc to either create a new document or overwrite the existing one
              await setDoc(personDocRef, person);
              document.getElementById('firebase-status').textContent = `Successfully saved ${person.name} to Firestore.`;
          } catch (error) {
              console.error("Error saving person to Firestore:", error);
              document.getElementById('firebase-status').textContent = `Error saving person: ${error.message}`;
          }
      }
      
      // Real-time listener to update the table when data changes in Firestore
      function subscribeToPeople() {
          if (!userId) return;
          const peopleCollectionRef = getPeopleCollectionRef();
          
          onSnapshot(peopleCollectionRef, (snapshot) => {
              pmState.list = snapshot.docs.map(doc => {
                  const data = doc.data();
                  return { ...data, firestoreId: doc.id };
              });
              pm_render();
              document.getElementById('firebase-status').textContent = `Loaded ${pmState.list.length} people from Firestore.`;
          }, (error) => {
              console.error("Error fetching people data:", error);
              document.getElementById('firebase-status').textContent = `Error fetching data: ${error.message}`;
          });
      }
      
      // --- UI/MANAGER LOGIC ---

      function pm_render(){
        const body = document.getElementById('pm_body');
        body.innerHTML = pmState.list.map((p, i) => {
          
          // Function to safely display date/place
          const formatDatePlace = (event) => {
            if (!event || (!event.date && !event.place)) return '—';
            const date = event.date ? `<strong>${event.date}</strong>` : '';
            const place = event.place ? ` @ ${event.place}` : '';
            return `${date}${place}`;
          };
          
          const parentsStr = (p.parents || []).join(', ');
          const spousesStr = (p.spouses || []).join(', ');

          return `
          <tr>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)">
              <input class="input" value="${p.name||''}" data-i="${i}" data-k="name" placeholder="Name" data-update-field="true"/><br>
              <input class="input small-id" value="${p.id||''}" data-i="${i}" data-k="id" style="font-size: 0.75em; opacity: 0.6;" placeholder="ID" data-update-field="true"/>
            </td>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)">
                ${formatDatePlace(p.birth)}<br>
                <button class="button small-action" data-i="${i}" data-action="edit-birth">Edit Birth</button>
            </td>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)">
                ${formatDatePlace(p.death)}<br>
                <button class="button small-action" data-i="${i}" data-action="edit-death">Edit Death</button>
            </td>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)">
                <input class="input" value="${parentsStr}" data-i="${i}" data-k="parents_str" placeholder="Parents IDs" data-update-field="true"/><br>
                <input class="input" value="${spousesStr}" data-i="${i}" data-k="spouses_str" placeholder="Spouses IDs" data-update-field="true"/>
            </td>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)">
                <textarea class="input" rows="2" data-i="${i}" data-k="summary" placeholder="Summary" data-update-field="true">${p.summary||''}</textarea>
            </td>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)">
              <button class="button" data-save="${i}">Save</button>
              <button class="button" data-del="${i}">Delete</button>
            </td>
          </tr>
          `;
        }).join('');
        
        // Event listeners for inline editing and saving
        body.querySelectorAll('[data-update-field="true"]').forEach(inp => {
          inp.addEventListener('input', (e)=>{
            const i = +e.target.dataset.i, k = e.target.dataset.k;
            const value = e.target.value;
            
            if(k === 'parents_str'){ 
                pmState.list[i].parents = value.split(',').map(s=>s.trim()).filter(Boolean);
                // Clear the temporary string key
                delete pmState.list[i].parents_str;
            } else if (k === 'spouses_str'){
                pmState.list[i].spouses = value.split(',').map(s=>s.trim()).filter(Boolean);
                // Clear the temporary string key
                delete pmState.list[i].spouses_str;
            } else if (k === 'name' && !pmState.list[i].id) {
                // Keep name and ID fields synced if ID wasn't custom set
                pmState.list[i].id = slugify(value + '-' + (pmState.list[i].birth?.date?.slice(-4) || ''));
                e.target.parentNode.querySelector('.small-id').value = pmState.list[i].id;
                pmState.list[i][k] = value;
            } else { 
                pmState.list[i][k] = value; 
            }
          });
        });

        // Save button listener
        body.querySelectorAll('[data-save]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const i = +e.target.dataset.save;
                const personToSave = pmState.list[i];
                // Ensure temporary keys are removed before saving
                delete personToSave.parents_str;
                delete personToSave.spouses_str;
                addPersonToFirestore(personToSave);
            });
        });
        
        // Delete button listener (to be implemented with deleteDoc)
        body.querySelectorAll('[data-del]').forEach(btn => {
          btn.addEventListener('click', (e)=>{
            const i = +e.target.dataset.del;
            const person = pmState.list[i];
            // NOTE: Using a confirmation dialog, but the prompt says to avoid confirm(). 
            // Since this is admin/dev code, we'll use a placeholder alert instead of confirm.
            alert(`To implement deletion for ${person.name}, you would call deleteDoc here.`);
          });
        });

        // Edit Details buttons (still a placeholder for now)
        body.querySelectorAll('[data-action^="edit-"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.target.dataset.action.replace('edit-', '');
                alert(`To implement full editing for ${action}, a separate modal window is needed. For now, please use the Add fields above.`);
            });
        });
      }
      
      // Add logic (now directly adds to Firestore)
      document.getElementById('pm_add').addEventListener('click', ()=>{
        const name = document.getElementById('pm_name').value.trim();
        if(!name){ alert('Name is required'); return; }
        
        const summary = document.getElementById('pm_summary').value.trim();
        const idIn = document.getElementById('pm_id').value.trim();
        const parentsIn = document.getElementById('pm_parents').value.trim();
        const spousesIn = document.getElementById('pm_spouses').value.trim();
        
        const bDate = document.getElementById('pm_birth_date').value.trim();
        const bPlace = document.getElementById('pm_birth_place').value.trim();
        const dDate = document.getElementById('pm_death_date').value.trim();
        const dPlace = document.getElementById('pm_death_place').value.trim();
        const mDate = document.getElementById('pm_marriage_date').value.trim();
        const mPlace = document.getElementById('pm_marriage_place').value.trim();
        
        const birthYear = bDate.slice(-4);
        const genId = slugify(name + '-' + birthYear);
        const id = idIn || genId;
        
        const parents = parentsIn ? parentsIn.split(',').map(s=>s.trim()).filter(Boolean) : [];
        const spouses = spousesIn ? spousesIn.split(',').map(s=>s.trim()).filter(Boolean) : [];
        
        const newPerson = { 
            id, 
            name, 
            summary, 
            parents, 
            spouses, 
            birth: { date: bDate || null, place: bPlace || null },
            death: { date: dDate || null, place: dPlace || null },
            marriage: { date: mDate || null, place: mPlace || null }
        };
        
        addPersonToFirestore(newPerson);

        // Clear input fields
        document.getElementById('pm_name').value = '';
        document.getElementById('pm_summary').value = '';
        document.getElementById('pm_id').value = '';
        document.getElementById('pm_parents').value = '';
        document.getElementById('pm_spouses').value = '';
        document.getElementById('pm_birth_date').value = '';
        document.getElementById('pm_birth_place').value = '';
        document.getElementById('pm_death_date').value = '';
        document.getElementById('pm_death_place').value = '';
        document.getElementById('pm_marriage_date').value = '';
        document.getElementById('pm_marriage_place').value = '';
      });

      // --- JSON Import Logic ---
      async function pm_importJSON(e){
        const file = e.target.files[0];
        if(!file) return;

        document.getElementById('firebase-status').textContent = `Reading file: ${file.name}...`;

        try{
          const text = await file.text();
          const peopleArray = JSON.parse(text);

          if(!Array.isArray(peopleArray)){
            document.getElementById('firebase-status').textContent = `Import Failed: Expected a JSON array, but received another format.`;
            return;
          }

          let successCount = 0;
          let failCount = 0;
          
          for (const person of peopleArray) {
              // Ensure basic fields for Firestore setDoc are present
              if (person.id && person.name) {
                  // Attempt to clean up and ensure structure matches expectations before saving
                  const cleanedPerson = {
                      id: person.id,
                      name: person.name,
                      summary: person.summary || '',
                      parents: Array.isArray(person.parents) ? person.parents : [],
                      spouses: Array.isArray(person.spouses) ? person.spouses : [],
                      // Use a generic birthYear/location if detailed fields aren't present
                      // NOTE: We don't save birthYear/location explicitly if we have the detailed objects
                      birth: person.birth || { date: null, place: person.location || null },
                      death: person.death || { date: null, place: null },
                      marriage: person.marriage || { date: null, place: null }
                  };
                  
                  await addPersonToFirestore(cleanedPerson); // Use existing saving function
                  successCount++;
              } else {
                  console.warn("Skipping record due to missing ID or Name:", person);
                  failCount++;
              }
              document.getElementById('firebase-status').textContent = `Importing... Success: ${successCount}, Failed: ${failCount}.`;
          }

          document.getElementById('firebase-status').textContent = `JSON Import Complete! ${successCount} records added/updated in Firestore. ${failCount} records skipped.`;

        } catch(err){
          console.error("Error during JSON import:", err);
          document.getElementById('firebase-status').textContent = `Import Failed: Error parsing file or writing to database. Check console for details.`;
        }
      }

      document.getElementById('pm_import_file').addEventListener('change', pm_importJSON);
      
      document.getElementById('pm_clear').addEventListener('click', ()=>{
        document.getElementById('pm_name').value = '';
        document.getElementById('pm_summary').value = '';
        document.getElementById('pm_id').value = '';
        document.getElementById('pm_parents').value = '';
        document.getElementById('pm_spouses').value = '';
        document.getElementById('pm_birth_date').value = '';
        document.getElementById('pm_birth_place').value = '';
        document.getElementById('pm_death_date').value = '';
        document.getElementById('pm_death_place').value = '';
        document.getElementById('pm_marriage_date').value = '';
        document.getElementById('pm_marriage_place').value = '';
      });
      
      // --- AUTHENTICATION INIT ---
      onAuthStateChanged(auth, async (user) => {
          if (user) {
              userId = user.uid;
              document.getElementById('firebase-status').textContent = `Authenticated as user ID: ${userId}. Loading data...`;
              subscribeToPeople();
          } else {
              // Sign in anonymously if no initial token is present
              if (initialAuthToken) {
                  await signInWithCustomToken(auth, initialAuthToken);
              } else {
                  await signInAnonymously(auth);
              }
          }
      });
      
    </script>


    <hr/>
    <h3 id="stories-manager">Stories Manager</h3>
    <p class="small">The Stories Manager still uses GitHub/Local JSON. To enable Firestore, similar changes would be needed here.</p>
    <div class="row">
      <input id="sm_title" class="input" placeholder="Title (required)"/>
      <input id="sm_year" class="input" placeholder="Year (e.g., 1975)"/>
    </div>
    <div class="row">
      <input id="sm_author" class="input" placeholder="Author"/>
      <input id="sm_summary" class="input" placeholder="One-line summary"/>
    </div>
    <label class="label">Content</label>
    <textarea id="sm_content" class="input" rows="6" placeholder="Full story text"></textarea>
    <div class="cta">
      <button id="sm_add" class="button">Add Story</button>
      <label class="button" for="sm_import_file" style="cursor:pointer">Import stories.json</label>
      <input id="sm_import_file" type="file" accept=".json,application/json" style="display:none"/>
      <button id="sm_export" class="button">Export stories.json</button>
      <button id="sm_commit" class="button">Commit stories.json to GitHub</button>
      <button id="sm_clear" class="button">Clear List</button>
    </div>
    <div id="sm_table_wrap" class="container" style="padding:0">
      <table id="sm_table" style="width:100%;border-collapse:collapse;margin-top:12px">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Title</th>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Year</th>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Author</th>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Summary</th>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Content</th>
            <th style="text-align:left;border-bottom:1px solid rgba(255,255,255,0.12);padding:8px">Actions</th>
          </tr>
        </thead>
        <tbody id="sm_body"></tbody>
      </table>
    </div>
    <!-- Script tag for Stories Manager (left for compatibility) -->
    <script>
      const SM_KEY = 'storiesManagerDraft';
      const smState = { list: [] };

      function sm_save(){ localStorage.setItem(SM_KEY, JSON.stringify(smState.list)); }
      function sm_load(){ try{ smState.list = JSON.parse(localStorage.getItem(SM_KEY)) || []; }catch(_){ smState.list=[]; } }
      function sm_render(){
        const body = document.getElementById('sm_body');
        body.innerHTML = smState.list.map((s,i)=>`
          <tr>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)"><input class="input" value="${s.title||''}" data-i="${i}" data-k="title"/></td>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)"><input class="input" value="${s.year||''}" data-i="${i}" data-k="year"/></td>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)"><input class="input" value="${s.author||''}" data-i="${i}" data-k="author"/></td>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)"><input class="input" value="${s.summary||''}" data-i="${i}" data-k="summary"/></td>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)"><textarea class="input" rows="4" data-i="${i}" data-k="content">${s.content || ''}</textarea></td>
            <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06)"><button class="button" data-sm-del="${i}">Delete</button></td>
          </tr>
        `).join('');
        body.querySelectorAll('input,textarea').forEach(el=>{
          el.addEventListener('input', e=>{
            const i = +e.target.dataset.i, k = e.target.dataset.k;
            smState.list[i][k] = e.target.value; sm_save();
          });
        });
        body.querySelectorAll('[data-sm-del]').forEach(btn=>{
          btn.addEventListener('click', e=>{
            const i = +e.target.dataset['smDel'];
            smState.list.splice(i,1); sm_save(); sm_render();
          });
        });
      }
      async function sm_boot(){
        sm_load();
        if(smState.list.length===0){
          try{ const r=await fetch('./data/stories.json',{cache:'no-store'}); if(r.ok){ smState.list=await r.json(); sm_save(); } }catch(_){}
        }
        sm_render();
      }
      function sm_download(name,text){
        const blob = new Blob([text], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
      }
      document.getElementById('sm_add').addEventListener('click',()=>{
        const t=document.getElementById('sm_title').value.trim(); if(!t){ alert('Title required'); return; }
        const y=document.getElementById('sm_year').value.trim(), a=document.getElementById('sm_author').value.trim(), s=document.getElementById('sm_summary').value.trim(), c=document.getElementById('sm_content').value;
        smState.list.unshift({title:t, year:y, author:a, summary:s, content:c});
        ['sm_title','sm_year','sm_author','sm_summary','sm_content'].forEach(id=>document.getElementById(id).value='');
        sm_save(); sm_render();
      });
      document.getElementById('sm_export').addEventListener('click',()=> sm_download('stories.json', JSON.stringify(smState.list,null,2)));
      document.getElementById('sm_import_file').addEventListener('change', async (e)=>{
        const f=e.target.files[0]; if(!f) return; const txt=await f.text();
        try{ const arr=JSON.parse(txt); if(Array.isArray(arr)){ smState.list=arr; sm_save(); sm_render(); } else alert('Invalid JSON (expected array)'); }catch(_){ alert('Could not parse JSON'); }
      });
      document.getElementById('sm_clear').addEventListener('click',()=>{ if(confirm('Clear draft stories?')){ smState.list=[]; sm_save(); sm_render(); } });
      sm_boot();
    </script>


    <hr/>
    <h3 id="photos-manager">Photos Manager</h3>
    <p class="small">The Photos Manager still uses GitHub/Local JSON. To enable Firestore, similar changes would be needed here.</p>
    <div class="row">
      <input id="pm2_src" class="input" placeholder="Image URL (required)"/>
      <input id="pm2_alt" class="input" placeholder="Alt text / caption"/>
    </div>
    <div class="cta">
      <button id="pm2_add" class="button">Add Photo</button>
      <input id="pm2_files" type="file" multiple accept="image/*" style="display:none"/>
      <label class="button" for="pm2_files" style="cursor:pointer">Choose Images</label>
      <button id="pm2_upload" class="button">Upload to GitHub & Add</button>
      <label class="button" for="pm2_import_file" style="cursor:pointer">Import photos.json</label>
      <input id="pm2_import_file" type="file" accept=".json,application/json" style="display:none"/>
      <button id="pm2_export" class="button">Export photos.json</button>
      <button id="pm2_commit" class="button">Commit photos.json to GitHub</button>
      <button id="pm2_clear" class="button">Clear List</button>
    </div>
    <div id="pm2_preview" class="gallery" style="margin-top:10px"></div>
    <div id="pm2_progress" class="small"></div>
    <div id="pm2_grid" class="gallery"></div>
    <!-- Script tag for Photos Manager (left for compatibility) -->
    <script>
      const PM2_KEY = 'photosManagerDraft';
      const pm2State = { list: [] };
      function pm2_save(){ localStorage.setItem(PM2_KEY, JSON.stringify(pm2State.list)); }
      function pm2_load(){ try{ pm2State.list = JSON.parse(localStorage.getItem(PM2_KEY)) || []; }catch(_){ pm2State.list=[]; } }
      function pm2_render(){
        const grid = document.getElementById('pm2_grid');
        grid.innerHTML = pm2State.list.map((p,i)=>`
          <div style="position:relative">
            <img src="${p.src}" alt="${p.alt||''}" style="width:100%;height:150px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.08)"/>
            <div class="small" style="margin-top:4px">${p.alt||''}</div>
            <button class="button" data-pm2-del="${i}" style="position:absolute;top:6px;right:6px">✕</button>
          </div>
        `).join('');
        grid.querySelectorAll('[data-pm2-del]').forEach(btn=>{
          btn.addEventListener('click', e=>{
            const i = +e.target.dataset.pm2Del;
            pm2State.list.splice(i,1); pm2_save(); pm2_render();
          });
        });
      }
      async function pm2_boot(){
        pm2_load();
        if(pm2State.list.length===0){
          try{ const r=await fetch('./data/photos.json',{cache:'no-store'}); if(r.ok){ pm2State.list = await r.json(); pm2_save(); } }catch(_){}
        }
        pm2_render();
      }
      function pm2_download(name,text){
        const blob = new Blob([text], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
      }
      document.getElementById('pm2_add').addEventListener('click', ()=>{
        const src = document.getElementById('pm2_src').value.trim(); if(!src){ alert('Image URL required'); return; }
        const alt = document.getElementById('pm2_alt').value.trim();
        pm2State.list.unshift({src, alt}); document.getElementById('pm2_src').value=''; document.getElementById('pm2_alt').value='';
        pm2_save(); pm2_render();
      });
      document.getElementById('pm2_export').addEventListener('click', ()=> pm2_download('photos.json', JSON.stringify(pm2State.list,null,2)));
      document.getElementById('pm2_import_file').addEventListener('change', async (e)=>{
        const f=e.target.files[0]; if(!f) return; const txt=await f.text();
        try{ const arr=JSON.parse(txt); if(Array.isArray(arr)){ pm2State.list=arr; pm2_save(); pm2_render(); } else alert('Invalid JSON (expected array)'); }catch(_){ alert('Could not parse JSON'); }
      });
      document.getElementById('pm2_clear').addEventListener('click', ()=>{ if(confirm('Clear draft photos?')){ pm2State.list=[]; pm2_save(); pm2_render(); } });
      pm2_boot();
    </script>
    
    <hr/>
    <h3 id="github-settings">GitHub Settings</h3>
    <p class="small">These settings are only used for committing the static JSON files (Stories, Photos, Tree Embed). People data is now saved to Firestore.</p>
    <div class="row">
      <input id="gh_owner" class="input" placeholder="Owner (e.g., your-username)"/>
      <input id="gh_repo" class="input" placeholder="Repository (e.g., family-history-site)"/>
    </div>
    <div class="row">
      <input id="gh_branch" class="input" placeholder="Branch (e.g., main)"/>
      <input id="gh_images_path" class="input" placeholder="Image Path (e.g., assets/photos)"/>
    </div>
    <label class="label">GitHub Personal Access Token (PAT)</label>
    <input id="gh_token" class="input" type="password" placeholder="Requires 'repo' scope"/>
    <div class="cta">
      <button id="gh_save" class="button">Save Settings</button>
      <button id="gh_clear" class="button">Clear Saved Settings</button>
    </div>
    <p class="small">The token is only stored in your browser's local storage.</p>
    <script>
      // ---- GitHub client-side commits (left for other managers) ----
      const GH_KEY = 'familySiteGithubSettings';
      function gh_get(){
        try{ return JSON.parse(localStorage.getItem(GH_KEY)) || {}; }catch(_){ return {}; }
      }
      function gh_set(cfg){
        localStorage.setItem(GH_KEY, JSON.stringify(cfg));
      }
      function gh_cfgFromInputs(){
        return {
          owner: document.getElementById('gh_owner').value.trim(),
          repo: document.getElementById('gh_repo').value.trim(),
          branch: document.getElementById('gh_branch').value.trim() || 'main',
          images_path: document.getElementById('gh_images_path').value.trim() || 'assets/photos',
          token: document.getElementById('gh_token').value.trim()
        };
      }
      function gh_fillInputs(cfg){
        if(!cfg) return;
        document.getElementById('gh_owner').value = cfg.owner || '';
        document.getElementById('gh_repo').value = cfg.repo || '';
        document.getElementById('gh_branch').value = cfg.branch || 'main';
        document.getElementById('gh_images_path').value = cfg.images_path || 'assets/photos';
        document.getElementById('gh_token').value = cfg.token || '';
      }
      function gh_init(){
        gh_fillInputs(gh_get());
        document.getElementById('gh_save').addEventListener('click', ()=>{
          gh_set(gh_cfgFromInputs());
          alert('Saved locally.');
        });
        document.getElementById('gh_clear').addEventListener('click', ()=>{
          localStorage.removeItem(GH_KEY); gh_fillInputs({});
        });
        // Prefill defaults
        try {
          const existing = JSON.parse(localStorage.getItem(GH_KEY) || 'null');
          if (!existing) {
            const defaults = {
              owner: 'pplum71',
              repo: 'Plummer-Family-History',
              branch: 'main',
              images_path: 'assets/photos',
              token: ''
            };
            document.getElementById('gh_owner').value = defaults.owner;
            document.getElementById('gh_repo').value = defaults.repo;
            document.getElementById('gh_branch').value = defaults.branch;
            document.getElementById('gh_images_path').value = defaults.images_path;
          }
        } catch (e) {}
      }
      function gh_headers(token){
        return { 
          'Accept':'application/vnd.github+json',
          'Authorization': 'Bearer ' + token,
          'X-GitHub-Api-Version': '2022-11-28',
          'Content-Type': 'application/json'
        };
      }
      async function gh_getFileSha(cfg, path){
        const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(cfg.branch)}`;
        const r = await fetch(url, { headers: gh_headers(cfg.token) });
        if(r.status === 200){ const j = await r.json(); return j.sha; }
        return null; // not found means create
      }
      async function gh_commitFile(cfg, path, contentBase64, message){
        const sha = await gh_getFileSha(cfg, path);
        const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
        const body = { message, content: contentBase64, branch: cfg.branch };
        if(sha) body.sha = sha;
        const r = await fetch(url, { method:'PUT', headers: gh_headers(cfg.token), body: JSON.stringify(body) });
        if(!r.ok){ const t = await r.text(); throw new Error('GitHub commit failed: ' + t); }
        return r.json();
      }
      function toBase64(arrayBuffer){
        let binary = '';
        const bytes = new Uint8Array(arrayBuffer);
        const len = bytes.byteLength;
        for(let i=0; i<len; i++){ binary += String.fromCharCode(bytes[i]); }
        return btoa(binary);
      }
      function gh_rawUrl(cfg, path){
        return `https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/${cfg.branch}/${path}`;
      }
      
      // Placeholder commit functions for the other managers
      async function sm_commit_json(){
        const cfg = gh_cfgFromInputs(); if(!cfg.owner||!cfg.repo||!cfg.token){ alert('Set GitHub settings first'); return; }
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(smState.list, null, 2))));
        try{ await gh_commitFile(cfg, 'data/stories.json', content, 'Update stories.json via Admin'); alert('Committed stories.json'); }
        catch(e){ alert(e.message); }
      }
      async function pm2_commit_json(){
        const cfg = gh_cfgFromInputs(); if(!cfg.owner||!cfg.repo||!cfg.token){ alert('Set GitHub settings first'); return; }
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(pm2State.list, null, 2))));
        try{ await gh_commitFile(cfg, 'data/photos.json', content, 'Update photos.json via Admin'); alert('Committed photos.json'); }
        catch(e){ alert(e.message); }
      }
      async function pm2_upload_files(){
        const cfg = gh_cfgFromInputs(); if(!cfg.owner||!cfg.repo||!cfg.token){ alert('Set GitHub settings first'); return; }
        const input = document.getElementById('pm2_files');
        if(!input.files.length){ alert('Choose images first'); return; }
        for(const file of input.files){
          const buf = await file.arrayBuffer();
          const b64 = toBase64(buf);
          const path = `${cfg.images_path.replace(/\/$/,'')}/${file.name}`;
          try{
            await gh_commitFile(cfg, path, b64, `Add photo ${file.name} via Admin`);
            const url = gh_rawUrl(cfg, path);
            // add to photos list
            pm2State.list.unshift({src: url, alt: file.name.replace(/[-_]/g,' ').replace(/\.[^.]+$/,'')});
          }catch(e){
            alert('Upload failed for ' + file.name + ': ' + e.message);
          }
        }
        pm2_save(); pm2_render();
        alert('Upload(s) done. Remember to Commit photos.json to GitHub to publish the updated gallery.');
      }

      // Hook GitHub init and button wiring after page load
      window.addEventListener('DOMContentLoaded', ()=>{
        gh_init();
        const b2 = document.getElementById('sm_commit'); if(b2) b2.addEventListener('click', sm_commit_json);
        const b3 = document.getElementById('pm2_commit'); if(b3) b3.addEventListener('click', pm2_commit_json);
        const b4 = document.getElementById('pm2_upload'); if(b4) b4.addEventListener('click', pm2_upload_files);
      });
    </script>


    <hr/>
    <h3>Deployment</h3>
    <p>Use GitHub Pages or Netlify to host. See <a href="./README.html">README</a> for step‑by‑step.</p>
  


</div>
</main>
<!-- TEMPORARILY COMMENTED OUT to grant access. REMOVE COMMENT AFTER SETTING NEW KEY. -->
<!--<script>adminGate("P@ttasPMJaca0292")</script> -->

  <footer>
    © <span id="y"></span> Plummer Family — Built with care. | <span class="small">Admin: open <code>/admin.html?key=P@ttasPMJaca0292</code></span>
  </footer>
  <script src="./assets/script.js"></script>
  <script>document.getElementById('y').textContent=new Date().getFullYear()</script>
</body>
</html>
